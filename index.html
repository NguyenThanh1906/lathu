<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy Birthday</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
  font-family:'Poppins',sans-serif;
}
canvas{
  position:fixed;
  inset:0;
}
</style>
</head>

<body>

<canvas id="stars"></canvas>
<canvas id="fx"></canvas>

<script>
/* ================= CANVAS ================= */
const stars = document.getElementById("stars");
const fx = document.getElementById("fx");
const stx = stars.getContext("2d");
const ftx = fx.getContext("2d");

function resize(){
  stars.width = fx.width = innerWidth;
  stars.height = fx.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* ================= STARFIELD ================= */
let starArr=[];
for(let i=0;i<240;i++){
  starArr.push({
    x:Math.random()*stars.width,
    y:Math.random()*stars.height,
    s:Math.random()*0.6+0.3
  });
}

function drawStars(){
  stx.fillStyle="rgba(0,0,0,0.35)";
  stx.fillRect(0,0,stars.width,stars.height);
  stx.fillStyle="#fff";
  starArr.forEach(s=>{
    s.y+=s.s;
    if(s.y>stars.height){
      s.y=0;
      s.x=Math.random()*stars.width;
    }
    stx.fillRect(s.x,s.y,2,6);
  });
}

/* ================= DRONE TEXT ================= */
const texts = ["3","2","1","HAPPY","BIRTHDAY"];
let idx = 0;
let points = [];
let hold = 0;

/* AUTO FIT FONT — KHÔNG XUỐNG DÒNG */
function fitFontSize(ctx, text, maxWidth, startSize){
  let size = startSize;
  ctx.font = `800 ${size}px Poppins`;
  while(ctx.measureText(text).width > maxWidth && size > 40){
    size -= 4;
    ctx.font = `800 ${size}px Poppins`;
  }
  return size;
}

function buildText(txt){
  points=[];
  const off = document.createElement("canvas");
  off.width = fx.width;
  off.height = fx.height;
  const o = off.getContext("2d");

  const isMobile = innerWidth < 768;
  const isNumber = /^[0-9]+$/.test(txt);

  let baseSize;
  if(isNumber){
    baseSize = isMobile ? fx.height*0.7 : fx.height*0.55;
  }else{
    baseSize = isMobile ? fx.width*0.55 : fx.width*0.32;
  }

  const fontSize = isNumber
    ? baseSize
    : fitFontSize(o, txt, fx.width*0.85, baseSize);

  o.clearRect(0,0,off.width,off.height);
  o.fillStyle="#fff";
  o.textAlign="center";
  o.textBaseline="middle";
  o.font = `800 ${fontSize}px Poppins`;
  o.fillText(txt, off.width/2, off.height/2);

  const img = o.getImageData(0,0,off.width,off.height).data;

  const step = isNumber
    ? (isMobile ? 16 : 20)
    : (isMobile ? 10 : 12);

  for(let y=0;y<off.height;y+=step){
    for(let x=0;x<off.width;x+=step){
      if(img[(y*off.width+x)*4+3] > 200){
        points.push({
          x:Math.random()*fx.width,
          y:Math.random()*fx.height,
          tx:x,
          ty:y,
          vx:0,
          vy:0
        });
      }
    }
  }
}

/* INIT */
document.fonts.ready.then(()=>buildText(texts[0]));

/* TEXT TIMING */
setInterval(()=>{
  hold++;
  if(hold < 40) return;
  hold = 0;
  idx++;
  if(idx < texts.length){
    buildText(texts[idx]);
  }
},120);

/* DRONE DRAW */
function drawDrone(){
  ftx.clearRect(0,0,fx.width,fx.height);
  points.forEach(p=>{
    p.vx += (p.tx - p.x) * 0.025;
    p.vy += (p.ty - p.y) * 0.025;
    p.vx *= 0.82;
    p.vy *= 0.82;
    p.x += p.vx;
    p.y += p.vy;

    ftx.fillStyle = "rgba(255,170,200,0.95)";
    ftx.fillRect(p.x,p.y,3,3);
  });
}

/* ================= LOOP ================= */
function loop(){
  drawStars();
  drawDrone();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
